<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配信ビューア</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #18181b;
      color: #fff;
      overflow: hidden;
    }
    /* 左エリア（動画+弾幕） */
    #video-container {
      position: relative;
      flex: 2;
      height: 100%;
      background: black;
    }
    #stream {
      width: 100%;
      height: 100%;
      border: none;
    }
    #danmaku {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku-message {
      position: absolute;
      white-space: nowrap;
      font-weight: bold;
      animation: moveLeft linear forwards;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .danmaku-message img {
      height: 1em;
      vertical-align: middle;
    }
    @keyframes moveLeft {
      from { left: 100%; }
      to { left: -100%; }
    }

    /* 右エリア（公式チャットiframe） */
    #chat {
      flex: 1;
      height: 100%;
      border: none;
    }

    /* 設定パネル */
    #settingsPanel {
      position: absolute;
      top: 50px;
      left: 10px;
      background: rgba(30,30,30,0.9);
      padding: 10px;
      border-radius: 8px;
      display: none;
      z-index: 1000;
    }
    #togglePanelBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- 左：配信 + 弾幕 -->
  <div id="video-container">
    <iframe id="stream" allowfullscreen></iframe>
    <div id="danmaku"></div>
  </div>

  <!-- 右：公式チャット -->
  <iframe id="chat"></iframe>

  <!-- 設定ボタン -->
  <button id="togglePanelBtn">⚙️ 設定</button>

  <!-- 設定パネル -->
  <div id="settingsPanel">
    <h3>弾幕設定</h3>
    <label>速度: <input type="range" id="speed" min="3" max="15" value="8"></label><br>
    <label>透明度: <input type="range" id="opacity" min="10" max="100" value="100"></label><br>
    <label>文字サイズ: <input type="range" id="fontSize" min="12" max="48" value="20"></label><br>
    <label><input type="checkbox" id="shadow" checked> 影</label><br>
    <label><input type="checkbox" id="outline" checked> 縁取り</label><br>
    <label><input type="checkbox" id="toggleChat" checked> チャット表示</label><br>
    <label><input type="checkbox" id="overlayChat"> チャットをオーバーレイ</label><br>
    <button id="resetBtn">リセット</button>
  </div>

  <!-- tmi.js（CDN） -->
  <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel") || "kato_junichi0817";

    // Twitch プレイヤー埋め込み
    document.getElementById("stream").src =
      `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&muted=true`;

    // Twitch 公式チャット埋め込み（ダークモード）
    document.getElementById("chat").src =
      `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}&darkpopout`;

    // 弾幕設定
    let settings = {
      speed: 8,
      opacity: 1,
      fontSize: 20,
      shadow: true,
      outline: true
    };

    // tmi.js クライアント
    const client = new tmi.Client({
      connection: { reconnect: true },
      channels: [ channel ]
    });
    client.connect();

    client.on("message", (chan, tags, message, self) => {
      if(self) return;
      addDanmaku(message, tags.emotes);
    });

    // 弾幕表示
    function addDanmaku(text, emotes) {
      const danmaku = document.getElementById("danmaku");
      const msg = document.createElement("div");
      msg.className = "danmaku-message";
      msg.style.top = `${Math.random() * 80}%`;
      msg.style.fontSize = `${settings.fontSize}px`;
      msg.style.opacity = settings.opacity;
      msg.style.animationDuration = `${settings.speed}s`;
      msg.style.color = "white";

      let style = "";
      if (settings.shadow) style += "2px 2px 4px rgba(0,0,0,0.8)";
      if (settings.outline) style += ", -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000";
      msg.style.textShadow = style;

      // テキスト + エモート置換
      let parts = parseMessageWithEmotes(text, emotes);
      parts.forEach(p => {
        if (p.type === "text") {
          let span = document.createElement("span");
          span.textContent = p.value;
          msg.appendChild(span);
        } else if (p.type === "emote") {
          let img = document.createElement("img");
          img.src = `https://static-cdn.jtvnw.net/emoticons/v2/${p.id}/default/dark/2.0`;
          msg.appendChild(img);
        }
      });

      danmaku.appendChild(msg);
      setTimeout(() => msg.remove(), settings.speed * 1000);
    }

    // エモートパース
    function parseMessageWithEmotes(message, emotes) {
      if (!emotes) return [{ type: "text", value: message }];
      let result = [];
      let lastIndex = 0;
      Object.entries(emotes).forEach(([id, positions]) => {
        positions.forEach(pos => {
          let [start, end] = pos.split("-").map(Number);
          if (lastIndex < start) {
            result.push({ type: "text", value: message.slice(lastIndex, start) });
          }
          result.push({ type: "emote", id });
          lastIndex = end + 1;
        });
      });
      if (lastIndex < message.length) {
        result.push({ type: "text", value: message.slice(lastIndex) });
      }
      return result;
    }

    // 設定パネル
    const panel = document.getElementById("settingsPanel");
    const btn = document.getElementById("togglePanelBtn");
    btn.onclick = () => {
    if (panel.style.display === "" || panel.style.display === "none") {
      panel.style.display = "block";
    } else {
      panel.style.display = "none";
    }
  };


    document.getElementById("speed").oninput = e => settings.speed = 18 - e.target.value;
    document.getElementById("opacity").oninput = e => settings.opacity = e.target.value / 100;
    document.getElementById("fontSize").oninput = e => settings.fontSize = e.target.value;
    document.getElementById("shadow").onchange = e => settings.shadow = e.target.checked;
    document.getElementById("outline").onchange = e => settings.outline = e.target.checked;
    document.getElementById("toggleChat").onchange = e => {
      document.getElementById("chat").style.display = e.target.checked ? "block" : "none";
    };
    document.getElementById("overlayChat").onchange = e => {
      if(e.target.checked) {
        document.getElementById("chat").style.position = "absolute";
        document.getElementById("chat").style.right = "0";
        document.getElementById("chat").style.width = "30%";
        document.getElementById("chat").style.height = "100%";
        document.getElementById("chat").style.opacity = "0.7";
      } else {
        document.getElementById("chat").style.position = "static";
        document.getElementById("chat").style.width = "auto";
        document.getElementById("chat").style.opacity = "1";
      }
    };
    document.getElementById("resetBtn").onclick = () => {
      settings = { speed: 8, opacity: 1, fontSize: 20, shadow: true, outline: true };
      document.getElementById("speed").value = 8;
      document.getElementById("opacity").value = 100;
      document.getElementById("fontSize").value = 20;
      document.getElementById("shadow").checked = true;
      document.getElementById("outline").checked = true;
      document.getElementById("toggleChat").checked = true;
      document.getElementById("chat").style.display = "block";
      document.getElementById("overlayChat").checked = false;
    };
  </script>
</body>
</html>
