<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Twitch Viewer</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #111;
      color: white;
    }
    #video-area {
      position: relative;
      width: 75%;
      height: 100%;
      background: black;
      overflow: hidden;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    #chat {
      width: 25%;
      height: 100%;
    }
    .danmaku {
      position: absolute;
      white-space: nowrap;
      color: white;
      font-size: 22px;
      font-weight: bold;
      text-shadow: 2px 2px 4px black;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="video-area"></div>
  <div id="chat"></div>

  <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <script>
    // URLの?channel=〇〇 を取得
    const params = new URLSearchParams(window.location.search);
    const channelName = params.get("channel");

    if (!channelName) {
      document.body.innerHTML = "<h1>チャンネル名が指定されていません</h1>";
    } else {
      // プレイヤー埋め込み
      document.getElementById("video-area").innerHTML = `
        <iframe src="https://player.twitch.tv/?channel=${channelName}&parent=crow-streaming.github.io" allowfullscreen></iframe>
      `;

      // チャット埋め込み
      document.getElementById("chat").innerHTML = `
        <iframe src="https://www.twitch.tv/embed/${channelName}/chat?parent=crow-streaming.github.io"></iframe>
      `;

      // tmi.jsでコメント取得
      const client = new tmi.Client({
        channels: [ channelName ]
      });

      client.connect();

      client.on('message', (channel, tags, message, self) => {
        createDanmaku(message);
      });

      function createDanmaku(text) {
        const span = document.createElement("span");
        span.className = "danmaku";
        span.innerText = text;
        span.style.top = Math.random() * 500 + "px";
        document.getElementById("video-area").appendChild(span);

        span.animate(
          [{ transform: "translateX(100%)" }, { transform: "translateX(-100%)" }],
          { duration: 8000, easing: "linear" }
        ).onfinish = () => span.remove();
      }
    }
  </script>
</body>
</html>
