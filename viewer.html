<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>弾幕ビューア</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #18181b;
      color: #fff;
      overflow: hidden;
      font-family: sans-serif;
    }

    /* 左エリア（動画+弾幕） */
    #video-container {
      position: relative;
      flex: 2;
      height: 100%;
      background: black;
    }
    #stream {
      width: 100%;
      height: 100%;
      border: none;
    }
    #danmaku {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku-message {
      position: absolute;
      white-space: nowrap;
      font-weight: bold;
      animation: moveLeft linear forwards;
      display: flex;
      align-items: center;
    }
    @keyframes moveLeft {
      from { left: 100%; }
      to { left: -100%; }
    }
    .danmaku-message img {
      vertical-align: middle;
      margin: 0 2px;
    }

    /* 右エリア（公式チャット） */
    #chat {
      flex: 1;
      height: 100%;
      border: none;
    }

    /* コントロールパネル */
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 999;
    }
    #panel h3 {
      margin: 0 0 8px;
      cursor: pointer;
    }
    #panel-content {
      display: none;
    }
    #panel label {
      display: block;
      margin: 5px 0;
    }
    #panel input[type="range"] {
      width: 150px;
    }
    button {
      margin-top: 5px;
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- 左：配信 + 弾幕 -->
  <div id="video-container">
    <iframe id="stream" allowfullscreen></iframe>
    <div id="danmaku"></div>
  </div>

  <!-- 右：公式チャット -->
  <iframe id="chat"></iframe>

  <!-- パネル -->
  <div id="panel">
    <h3 id="panel-toggle">⚙ 設定パネル ▼</h3>
    <div id="panel-content">
      <label>速度 <input id="speed" type="range" min="4" max="20" value="8"></label>
      <label>透明度 <input id="opacity" type="range" min="10" max="100" value="100"></label>
      <label>文字サイズ <input id="fontSize" type="range" min="12" max="48" value="20"></label>
      <label><input id="shadow" type="checkbox" checked> 影</label>
      <label><input id="outline" type="checkbox" checked> 縁取り</label>
      <label><input id="toggleChat" type="checkbox" checked> チャット欄表示</label>
      <label><input id="overlayChat" type="checkbox"> チャットオーバーレイ</label>
      <button id="resetBtn">リセット</button>
    </div>
  </div>

  <!-- tmi.js (ES5ビルドCDN) -->
  <script src="https://cdn.jsdelivr.net/npm/tmijs-es5@1.0.0/index.min.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel") || "kato_junichi0817";

    // Twitchプレイヤー
    document.getElementById("stream").src =
      `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&muted=true`;

    // Twitch公式チャット（ダーク）
    document.getElementById("chat").src =
      `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}&darkpopout`;

    // デフォルト設定
    const defaultSettings = {
      speed: 8,
      opacity: 1.0,
      fontSize: 20,
      shadow: true,
      outline: true,
      showChat: true,
      overlayChat: false
    };
    let settings = { ...defaultSettings };

    // tmi.js クライアント
    const client = new tmi.Client({
      connection: { reconnect: true },
      channels: [ channel ]
    });
    client.connect();

    client.on("message", (chan, tags, message, self) => {
      if(self) return;
      addDanmaku(message, tags.emotes);
    });

    // 弾幕追加（テキスト＋エモート対応）
    function addDanmaku(text, emotes) {
      const danmaku = document.getElementById("danmaku");
      const msg = document.createElement("div");
      msg.className = "danmaku-message";
      msg.style.top = `${Math.random() * 80}%`;
      msg.style.fontSize = settings.fontSize + "px";
      msg.style.opacity = settings.opacity;
      msg.style.animationDuration = settings.speed + "s";

      // 影と縁取り
      let effects = [];
      if (settings.shadow) effects.push("2px 2px 4px rgba(0,0,0,0.8)");
      if (settings.outline) {
        effects.push(
          "-1px -1px 0 #000, 1px -1px 0 #000," +
          "-1px 1px 0 #000, 1px 1px 0 #000"
        );
      }
      msg.style.textShadow = effects.join(",");

      // メッセージをパーツに分解（エモートあれば画像に変換）
      if (emotes) {
        let fragments = [];
        let lastIndex = 0;
        const emotePositions = [];

        for (let id in emotes) {
          emotes[id].forEach(pos => {
            const [start, end] = pos.split("-").map(Number);
            emotePositions.push({ start, end, id });
          });
        }
        emotePositions.sort((a,b) => a.start - b.start);

        emotePositions.forEach(({ start, end, id }) => {
          if (lastIndex < start) {
            fragments.push(document.createTextNode(text.slice(lastIndex, start)));
          }
          const img = document.createElement("img");
          img.src = `https://static-cdn.jtvnw.net/emoticons/v2/${id}/default/dark/3.0`;
          img.style.height = settings.fontSize * 1.2 + "px";
          fragments.push(img);
          lastIndex = end + 1;
        });

        if (lastIndex < text.length) {
          fragments.push(document.createTextNode(text.slice(lastIndex)));
        }

        fragments.forEach(f => msg.appendChild(f));
      } else {
        msg.innerText = text;
      }

      danmaku.appendChild(msg);
      setTimeout(() => msg.remove(), settings.speed * 1000);
    }

    // UI操作
    document.getElementById("speed").oninput = e => settings.speed = Number(e.target.value);
    document.getElementById("opacity").oninput = e => settings.opacity = e.target.value / 100;
    document.getElementById("fontSize").oninput = e => settings.fontSize = Number(e.target.value);
    document.getElementById("shadow").onchange = e => settings.shadow = e.target.checked;
    document.getElementById("outline").onchange = e => settings.outline = e.target.checked;

    document.getElementById("toggleChat").onchange = e => {
      settings.showChat = e.target.checked;
      document.getElementById("chat").style.display = settings.showChat ? "block" : "none";
    };
    document.getElementById("overlayChat").onchange = e => {
      settings.overlayChat = e.target.checked;
      const chat = document.getElementById("chat");
      if(settings.overlayChat) {
        chat.style.position = "absolute";
        chat.style.right = "0";
        chat.style.top = "0";
        chat.style.height = "100%";
        chat.style.width = "30%";
        chat.style.opacity = "0.5";
        chat.style.pointerEvents = "none";
      } else {
        chat.style.position = "static";
        chat.style.opacity = "1.0";
        chat.style.pointerEvents = "auto";
      }
    };

    // リセットボタン
    document.getElementById("resetBtn").onclick = () => {
      settings = { ...defaultSettings };
      document.getElementById("speed").value = defaultSettings.speed;
      document.getElementById("opacity").value = defaultSettings.opacity * 100;
      document.getElementById("fontSize").value = defaultSettings.fontSize;
      document.getElementById("shadow").checked = defaultSettings.shadow;
      document.getElementById("outline").checked = defaultSettings.outline;
      document.getElementById("toggleChat").checked = defaultSettings.showChat;
      document.getElementById("overlayChat").checked = defaultSettings.overlayChat;

      // チャットリセット
      const chat = document.getElementById("chat");
      chat.style.display = "block";
      chat.style.position = "static";
      chat.style.opacity = "1.0";
      chat.style.pointerEvents = "auto";

      // 弾幕削除
      document.getElementById("danmaku").innerHTML = "";
    };

    // パネル開閉
    document.getElementById("panel-toggle").onclick = () => {
      const content = document.getElementById("panel-content");
      content.style.display = content.style.display === "none" ? "block" : "none";
    };
  </script>
</body>
</html>
