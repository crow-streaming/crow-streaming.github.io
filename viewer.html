<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配信ビューア</title>
  <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #18181b;
      color: #fff;
    }
    iframe {
      flex: 2;
      border: none;
    }
    #chat {
      flex: 1;
      background: #0e0e10;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      margin-bottom: 5px;
      font-size: 14px;
    }
    #danmaku {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku-message {
      position: absolute;
      white-space: nowrap;
      font-size: 20px;
      animation: moveLeft 8s linear forwards;
    }
    @keyframes moveLeft {
      from { left: 100%; }
      to { left: -100%; }
    }
  </style>
</head>
<body>
  <div style="position: relative; flex: 2;">
    <iframe id="stream" allowfullscreen></iframe>
    <div id="danmaku"></div>
  </div>
  <div id="chat"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel") || "kato_junichi0817";

    document.getElementById("stream").src = 
      `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}`;

    const client = new tmi.Client({ channels: [channel] });
    client.connect();

    const chat = document.getElementById("chat");
    const danmaku = document.getElementById("danmaku");

    client.on("message", (channel, tags, message) => {
      const msgElem = document.createElement("div");
      msgElem.className = "message";
      msgElem.textContent = `${tags["display-name"]}: ${message}`;
      chat.appendChild(msgElem);
      chat.scrollTop = chat.scrollHeight;

      const danmakuMsg = document.createElement("div");
      danmakuMsg.className = "danmaku-message";
      danmakuMsg.style.top = `${Math.random() * 90}%`;
      danmakuMsg.style.color = "#fff";
      danmakuMsg.textContent = message;
      danmaku.appendChild(danmakuMsg);

      danmakuMsg.addEventListener("animationend", () => {
        danmakuMsg.remove();
      });
    });
  </script>
</body>
</html>
