<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配信ビューア完全版</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #18181b;
      color: #fff;
      overflow: hidden;
    }

    /* 左エリア（動画+弾幕） */
    #video-container {
      position: relative;
      flex: 2;
      height: 100%;
      background: black;
    }
    #stream {
      width: 100%;
      height: 100%;
      border: none;
    }
    #danmaku {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku-message {
      position: absolute;
      white-space: nowrap;
      font-weight: bold;
      animation: moveLeft linear forwards;
      display: inline-flex;
      align-items: center;
      color: white;
      -webkit-text-stroke: 1px black;
      paint-order: stroke fill;
    }
    .danmaku-message.stroke {
      text-shadow:
        -1px -1px 0 black,
         1px -1px 0 black,
        -1px  1px 0 black,
         1px  1px 0 black;
    }
    @keyframes moveLeft {
      from { left: 100%; }
      to { left: -100%; }
    }
    .danmaku-message img {
      margin: 0 2px;
      vertical-align: middle;
    }

    /* 右エリア（オリジナルチャットオーバーレイ） */
    #chat-overlay {
      flex: 1;
      height: 100%;
      background: rgba(24,24,27,0.8);
      overflow-y: auto;
      padding: 8px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .chat-message {
      margin: 4px 0;
      word-break: break-word;
    }
    .chat-message img {
      height: 1.2em;
      vertical-align: middle;
      margin: 0 2px;
    }

    /* ⚙️ボタン */
    #settings-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: #333;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
    }

    /* 開閉パネル */
    #controls {
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 1000;
    }
    #controls label { display: block; margin: 4px 0; }
    #controls input[type=range] { width: 120px; }
  </style>
</head>
<body>
  <!-- 左：配信 + 弾幕 -->
  <div id="video-container">
    <iframe id="stream" allowfullscreen></iframe>
    <div id="danmaku"></div>
    <!-- ⚙️ -->
    <button id="settings-btn">⚙️</button>
    <div id="controls">
      <b>弾幕設定</b><br>
      <label><input type="checkbox" id="toggleUser"> ユーザー名表示</label>
      <label><input type="checkbox" id="toggleShadow" checked> 影</label>
      <label><input type="checkbox" id="toggleStroke"> 縁取り</label>
      透明度: <input type="range" id="opacity" min="0.2" max="1" step="0.1" value="1"><br>
      速度: <input type="range" id="speed" min="3" max="15" step="1" value="8"><br>
      サイズ: <input type="range" id="size" min="14" max="40" step="2" value="20"><br><hr>
      <b>チャット設定</b><br>
      透明度: <input type="range" id="chatOpacity" min="0.2" max="1" step="0.1" value="0.8"><br>
      サイズ: <input type="range" id="chatSize" min="12" max="24" step="1" value="14"><br>
    </div>
  </div>

  <!-- 右：チャット -->
  <div id="chat-overlay"></div>

  <!-- tmi.js -->
  <script src="./tmi.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel") || "kato_junichi0817";

    // Twitch プレイヤー
    document.getElementById("stream").src =
      `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&muted=true`;

    // tmi.js クライアント
    const client = new tmi.Client({
      connection: { reconnect: true },
      channels: [ channel ]
    });
    client.connect();

    // 設定値
    const settings = {
      showUser: false,
      opacity: 1,
      speed: 8,
      size: 20,
      shadow: true,
      stroke: false,
      chatOpacity: 0.8,
      chatSize: 14
    };

    // レーン管理
    const laneCount = 10;
    const lanes = Array(laneCount).fill(0);

    client.on("message", (chan, tags, message, self) => {
      if (self) return;
      addDanmaku(message, tags.emotes, tags["display-name"]);
      addChat(message, tags.emotes, tags["display-name"]);
    });

    // 弾幕追加
    function addDanmaku(text, emotes, username) {
      const danmaku = document.getElementById("danmaku");
      const msg = document.createElement("div");
      msg.className = "danmaku-message";
      msg.style.opacity = settings.opacity;
      msg.style.fontSize = settings.size + "px";
      msg.style.animationDuration = settings.speed + "s";

      let effects = [];
      if (settings.shadow) effects.push("2px 2px 4px rgba(0,0,0,0.8)");
      if (settings.stroke) msg.classList.add("stroke");
      else msg.classList.remove("stroke");
      msg.style.textShadow = effects.join(",");

      if (settings.showUser) {
        const nameSpan = document.createElement("span");
        nameSpan.textContent = username + ": ";
        msg.appendChild(nameSpan);
      }

      appendWithEmotes(msg, text, emotes, settings.size);

      // レーン割り当て
      const now = Date.now() / 1000;
      let laneIndex = lanes.findIndex(end => end <= now);
      if (laneIndex === -1) laneIndex = lanes.indexOf(Math.min(...lanes));
      lanes[laneIndex] = now + settings.speed;
      const lineHeight = settings.size * 1.2;
      msg.style.top = `${laneIndex * lineHeight}px`;

      danmaku.appendChild(msg);
      setTimeout(() => msg.remove(), settings.speed * 1000);
    }

    // オリジナルチャット追加
    function addChat(text, emotes, username) {
      const chat = document.getElementById("chat-overlay");
      const msg = document.createElement("div");
      msg.className = "chat-message";
      msg.style.fontSize = settings.chatSize + "px";
      msg.style.opacity = settings.chatOpacity;

      const nameSpan = document.createElement("span");
      nameSpan.style.fontWeight = "bold";
      nameSpan.textContent = username + ": ";
      msg.appendChild(nameSpan);

      appendWithEmotes(msg, text, emotes, settings.chatSize);

      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    // エモート埋め込み共通処理
    function appendWithEmotes(container, text, emotes, size) {
      if (emotes) {
        let fragments = [];
        let lastIndex = 0;
        const positions = [];
        for (let id in emotes) {
          emotes[id].forEach(pos => {
            const [start, end] = pos.split("-").map(Number);
            positions.push({ start, end, id });
          });
        }
        positions.sort((a,b) => a.start - b.start);
        positions.forEach(({ start, end, id }) => {
          if (lastIndex < start) {
            container.appendChild(document.createTextNode(text.slice(lastIndex, start)));
          }
          const img = document.createElement("img");
          img.src = `https://static-cdn.jtvnw.net/emoticons/v2/${id}/default/dark/3.0`;
          img.style.height = size * 1.2 + "px";
          container.appendChild(img);
          lastIndex = end + 1;
        });
        if (lastIndex < text.length) {
          container.appendChild(document.createTextNode(text.slice(lastIndex)));
        }
      } else {
        container.appendChild(document.createTextNode(text));
      }
    }

    // UI動作
    document.getElementById("toggleUser").onchange = e => settings.showUser = e.target.checked;
    document.getElementById("opacity").oninput = e => settings.opacity = e.target.value;
    document.getElementById("speed").oninput = e => settings.speed = e.target.value;
    document.getElementById("size").oninput = e => settings.size = e.target.value;
    document.getElementById("toggleShadow").onchange = e => settings.shadow = e.target.checked;
    document.getElementById("toggleStroke").onchange = e => settings.stroke = e.target.checked;
    document.getElementById("chatOpacity").oninput = e => {
      settings.chatOpacity = e.target.value;
      document.getElementById("chat-overlay").style.opacity = e.target.value;
    };
    document.getElementById("chatSize").oninput = e => {
      settings.chatSize = e.target.value;
      document.getElementById("chat-overlay").style.fontSize = e.target.value + "px";
    };

    // ⚙️開閉
    document.getElementById("settings-btn").onclick = () => {
      const panel = document.getElementById("controls");
      panel.style.display = (panel.style.display === "block") ? "none" : "block";
    };
  </script>
</body>
</html>
