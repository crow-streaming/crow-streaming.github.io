<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配信ビューア 完全版</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #18181b;
      color: #fff;
      overflow: hidden;
    }

    /* 左エリア（動画+弾幕） */
    #video-container {
      position: relative;
      flex: 2;
      height: 100%;
      background: black;
    }
    #stream {
      width: 100%;
      height: 100%;
      border: none;
    }
    #danmaku {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku-message {
      position: absolute;
      white-space: nowrap;
      font-weight: bold;
      animation: moveLeft linear forwards;
      color: white;
    }
    @keyframes moveLeft {
      from { transform: translateX(100%); }
      to { transform: translateX(-100%); }
    }

    /* 右エリア（公式チャット） */
    #chat {
      flex: 1;
      height: 100%;
      border: none;
    }

    /* オーバーレイ用チャット */
    #chat-overlay {
      position: absolute;
      top: 0;
      right: 0;
      width: 30%;
      height: 100%;
      border: none;
      background: rgba(24,24,27,0.8);
      display: none;
    }

    /* ⚙️ボタン */
    #settings-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: #333;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
    }

    /* 開閉パネル */
    #controls {
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 1000;
    }
    #controls label { display: block; margin: 4px 0; }
    #controls input[type=range] { width: 120px; }
  </style>
</head>
<body>
  <!-- 左：配信 + 弾幕 -->
  <div id="video-container">
    <iframe id="stream" allowfullscreen></iframe>
    <div id="danmaku"></div>
    <iframe id="chat-overlay"></iframe>

    <!-- ⚙️ボタンとパネル -->
    <button id="settings-btn">⚙️</button>
    <div id="controls">
      <label><input type="checkbox" id="toggleUser"> ユーザー名表示</label>
      <label><input type="checkbox" id="toggleChat" checked> チャット欄</label>
      <label><input type="checkbox" id="toggleOverlay"> オーバーレイ表示</label><hr>
      透明度: <input type="range" id="opacity" min="0.2" max="1" step="0.1" value="1"><br>
      速度: <input type="range" id="speed" min="3" max="15" step="1" value="8"><br>
      サイズ: <input type="range" id="size" min="14" max="40" step="2" value="20"><br>
      <label><input type="checkbox" id="toggleShadow" checked> 影</label>
      <label><input type="checkbox" id="toggleStroke"> 縁取り</label>
    </div>
  </div>

  <!-- 右：公式チャット -->
  <iframe id="chat"></iframe>

  <!-- tmi.js -->
  <script src="./tmi.min.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel") || "kato_junichi0817";

    // Twitch プレイヤー
    document.getElementById("stream").src =
      `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&muted=true`;

    // 公式チャット
    document.getElementById("chat").src =
      `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}&darkpopout`;
    document.getElementById("chat-overlay").src =
      `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}&darkpopout`;

    // tmi.js クライアント
    const client = new tmi.Client({
      connection: { reconnect: true },
      channels: [ channel ]
    });
    client.connect();

    // 設定値
    const settings = {
      showUser: false,
      opacity: 1,
      speed: 8,
      size: 20,
      shadow: true,
      stroke: false
    };

    // レーン管理
    const laneCount = 15; // 仮の最大レーン数
    const lanes = Array(laneCount).fill(null);

    client.on("message", (chan, tags, message, self) => {
      if(self) return;
      let text = settings.showUser
        ? `${tags['display-name']}: ${message}`
        : message;
      addDanmaku(text);
    });

    // 弾幕追加
    function addDanmaku(text) {
      const danmaku = document.getElementById("danmaku");
      const msg = document.createElement("div");
      msg.className = "danmaku-message";
      msg.innerHTML = text; // ← スタンプ対応
      msg.style.opacity = settings.opacity;
      msg.style.fontSize = settings.size + "px";
      msg.style.animationDuration = settings.speed + "s";

      if (settings.shadow) {
        msg.style.textShadow = "2px 2px 4px rgba(0,0,0,0.8)";
      } else {
        msg.style.textShadow = "none";
      }
      if (settings.stroke) {
        msg.style.webkitTextStroke = "1px black";
      } else {
        msg.style.webkitTextStroke = "0";
      }

      danmaku.appendChild(msg);

      // 幅を測る
      const msgWidth = msg.offsetWidth;
      const containerWidth = danmaku.offsetWidth;

      // レーンを探す
      let laneIndex = 0;
      for (let i = 0; i < laneCount; i++) {
        const last = lanes[i];
        if (!last) { laneIndex = i; break; }

        // 前コメントの進行度を計算
        const elapsed = (Date.now() - last.startTime) / 1000;
        const distance = (containerWidth + last.width) * (elapsed / settings.speed);
        const lastLeft = containerWidth - distance;

        if (lastLeft + last.width < containerWidth - msgWidth) {
          laneIndex = i;
          break;
        }
      }

      // 配置
      const lineHeight = settings.size * 1.2;
      msg.style.top = `${laneIndex * lineHeight}px`;

      // レーン更新
      lanes[laneIndex] = { el: msg, width: msgWidth, startTime: Date.now() };

      // 終了時に削除
      setTimeout(() => {
        msg.remove();
        if (lanes[laneIndex]?.el === msg) {
          lanes[laneIndex] = null;
        }
      }, settings.speed * 1000);
    }

    // UI の動作
    document.getElementById("toggleUser").onchange = e => settings.showUser = e.target.checked;
    document.getElementById("opacity").oninput = e => settings.opacity = e.target.value;
    document.getElementById("speed").oninput = e => settings.speed = e.target.value;
    document.getElementById("size").oninput = e => settings.size = e.target.value;
    document.getElementById("toggleShadow").onchange = e => settings.shadow = e.target.checked;
    document.getElementById("toggleStroke").onchange = e => settings.stroke = e.target.checked;

    document.getElementById("toggleChat").onchange = e => {
      document.getElementById("chat").style.display = e.target.checked ? "block" : "none";
    };

    document.getElementById("toggleOverlay").onchange = e => {
      document.getElementById("chat-overlay").style.display = e.target.checked ? "block" : "none";
    };

    document.getElementById("settings-btn").onclick = () => {
      const panel = document.getElementById("controls");
      panel.style.display = (panel.style.display === "block") ? "none" : "block";
    };
  </script>
</body>
</html>
