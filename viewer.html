<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配信ビューア</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#18181b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    body { margin:0; display:flex; height:100vh; background:#18181b; color:#fff; overflow:hidden; font-family:"Yu Gothic","Meiryo",sans-serif; }
    #video-container { position:relative; flex:2; height:100%; background:black; }
    #stream { width:100%; height:100%; border:none; }
    #danmaku { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden; }
    .danmaku-message { position:absolute; white-space:nowrap; font-weight:bold; animation:moveLeft linear forwards; display:inline-flex; align-items:center; color:white; -webkit-text-stroke:1px black; paint-order:stroke fill; }
    .danmaku-message.stroke { text-shadow:-1px -1px 0 black,1px -1px 0 black,-1px 1px 0 black,1px 1px 0 black; }
    @keyframes moveLeft { from { left:100%; } to { left:-100%; } }
    .danmaku-message img { display:inline-block; margin:0 2px; vertical-align:middle; }
    #chat, #alt-chat { flex:1; height:100%; border:none; display:none; }
    #settings-btn { position:absolute; bottom:10px; right:10px; background:rgba(50,50,50,0.6); border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; z-index:1000; display:flex; align-items:center; justify-content:center; }
    #controls { position:absolute; bottom:60px; right:10px; background:rgba(0,0,0,0.8); padding:10px; border-radius:8px; font-size:14px; display:none; z-index:1000; }
    #controls label { display:block; margin:4px 0; }
  </style>
</head>
<body>
<div id="video-container">
  <iframe id="stream" allow="autoplay; fullscreen"></iframe>
  <div id="danmaku"></div>
  <button id="settings-btn">⚙️</button>
  <div id="controls">
    <label><input type="checkbox" id="toggleUser"> ユーザー名表示</label>
    <label><input type="checkbox" id="toggleDanmaku" checked> 弾幕表示</label>
    <label><input type="checkbox" id="toggleChat" checked> 公式チャット</label>
    <label><input type="checkbox" id="toggleAltChat"> 代替チャット</label><hr>
    速度: <input type="range" id="speed" min="3" max="15"><br>
    透明度: <input type="range" id="opacity" min="0.2" max="1" step="0.1"><br>
    サイズ: <input type="range" id="size" min="14" max="40" step="2"><br>
    <label><input type="checkbox" id="toggleShadow" checked> 影</label>
    <label><input type="checkbox" id="toggleStroke"> 縁取り</label><hr>
    <button id="unmute-btn">🔊 ミュート解除</button>
  </div>
</div>
<iframe id="chat"></iframe>
<div id="alt-chat" style="background:#222; color:#fff; overflow:auto;"></div>

<script src="./tmi.min.js"></script>
<script>
const params=new URLSearchParams(window.location.search);
const channel=params.get("channel")||"kato_junichi0817";

// Twitch埋め込みURL（最初はミュート自動再生）
document.getElementById("stream").src=`https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&muted=true&autoplay=true`;
document.getElementById("chat").src=`https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}&darkpopout`;

const client=new tmi.Client({connection:{reconnect:true},channels:[channel]});
client.connect();

// 設定保存
let settings={showUser:false,speed:8,opacity:1,size:20,shadow:true,stroke:false,danmaku:true,toggleChat:true,altChat:false};
const saved=localStorage.getItem("settings");
if(saved) settings={...settings,...JSON.parse(saved)};

// UI反映
const applySettings=()=>{
  document.getElementById("toggleUser").checked=settings.showUser;
  document.getElementById("speed").value=settings.speed;
  document.getElementById("opacity").value=settings.opacity;
  document.getElementById("size").value=settings.size;
  document.getElementById("toggleShadow").checked=settings.shadow;
  document.getElementById("toggleStroke").checked=settings.stroke;
  document.getElementById("toggleDanmaku").checked=settings.danmaku;
  document.getElementById("toggleChat").checked=settings.toggleChat;
  document.getElementById("toggleAltChat").checked=settings.altChat;
  document.getElementById("chat").style.display=settings.toggleChat?"block":"none";
  document.getElementById("alt-chat").style.display=settings.altChat?"block":"none";
  document.getElementById("danmaku").style.display=settings.danmaku?"block":"none";
};
applySettings();

function saveSettings(){localStorage.setItem("settings",JSON.stringify(settings));}

// イベント
["toggleUser","speed","opacity","size","toggleShadow","toggleStroke","toggleDanmaku","toggleChat","toggleAltChat"]
.forEach(id=>{
  document.getElementById(id).onchange=e=>{
    const el=e.target;
    if(el.type==="checkbox") settings[id.replace("toggle","").toLowerCase()]=el.checked;
    else settings[id.replace("toggle","").toLowerCase()]=parseFloat(el.value);
    applySettings();saveSettings();
  }
});
document.getElementById("settings-btn").onclick=()=>{const c=document.getElementById("controls");c.style.display=(c.style.display==="block")?"none":"block";};
document.getElementById("unmute-btn").onclick=()=>{
  document.getElementById("stream").src=`https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&autoplay=true&muted=false`;
};

// レーン管理
let lanes=[];
function getLaneCount(){return Math.floor(document.getElementById("danmaku").clientHeight/(settings.size*1.2));}

client.on("message",(chan,tags,message,self)=>{
  if(self) return;
  if(settings.danmaku) addDanmaku(message,tags.emotes,tags['display-name']);
  if(settings.altChat) addAltChat(tags['display-name'],message);
});

function addDanmaku(text,emotes,username){
  const danmaku=document.getElementById("danmaku");
  const msg=document.createElement("div");
  msg.className="danmaku-message";
  msg.style.opacity=settings.opacity;
  msg.style.fontSize=settings.size+"px";
  msg.style.animationDuration=settings.speed+"s";
  let effects=[];
  if(settings.shadow) effects.push("2px 2px 4px rgba(0,0,0,0.8)");
  if(settings.stroke){msg.classList.add("stroke");msg.style.webkitTextStroke="1px black";}
  msg.style.textShadow=effects.join(",");
  if(settings.showUser){msg.appendChild(document.createTextNode(username+": "));}
  msg.appendChild(document.createTextNode(text));
  const laneCount=getLaneCount();
  if(lanes.length!==laneCount) lanes=Array(laneCount).fill(0);
  const now=Date.now()/1000;
  let laneIndex=lanes.findIndex(end=>end<=now);
  if(laneIndex===-1) laneIndex=lanes.indexOf(Math.min(...lanes));
  lanes[laneIndex]=now+settings.speed;
  msg.style.top=`${laneIndex*settings.size*1.2}px`;
  danmaku.appendChild(msg);
  setTimeout(()=>msg.remove(),settings.speed*1000);
}

function addAltChat(user,text){
  const box=document.getElementById("alt-chat");
  const div=document.createElement("div");
  div.textContent=`${user}: ${text}`;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}
</script>
</body>
</html>
