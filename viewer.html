<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配信ビューア</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #18181b;
      color: #fff;
      overflow: hidden;
    }

    /* 左エリア（動画+弾幕） */
    #video-container {
      position: relative;
      flex: 2;
      height: 100%;
      background: black;
    }
    #stream {
      width: 100%;
      height: 100%;
      border: none;
    }
    #danmaku {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku-message {
      position: absolute;
      white-space: nowrap;
      font-weight: bold;
      animation: moveLeft linear forwards;
      display: inline-flex;
      align-items: center;
      color: white;
      -webkit-text-stroke: 1px black; /* 縁取り */
      paint-order: stroke fill;       /* 枠を先に描画してズレ防止 */
    }
    .danmaku-message.stroke {
      text-shadow:
        -1px -1px 0 black,
         1px -1px 0 black,
        -1px  1px 0 black,
         1px  1px 0 black;
    }

    @keyframes moveLeft {
      from { left: 100%; }
      to { left: -100%; }
    }

    .danmaku-message img {
      display: inline-block;
      margin: 0 2px;
      vertical-align: middle;
      text-shadow: none !important;
      filter: none !important;
    }

    /* 右エリア（公式チャット） */
    #chat {
      flex: 1;
      height: 100%;
      border: none;
    }

    /* ⚙️ボタン */
    #settings-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: #333;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    /* PC時: マウスが配信画面にあるときだけ表示 */
    #video-container:hover #settings-btn {
      opacity: 1;
      pointer-events: auto;
    }

    /* 開閉パネル */
    #controls {
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 1000;
    }
    #controls label { display: block; margin: 4px 0; }
    #controls input[type=range] { width: 120px; }
  </style>
</head>
<body>
  <!-- 左：配信 + 弾幕 -->
  <div id="video-container">
    <iframe id="stream" allowfullscreen></iframe>
    <div id="danmaku"></div>

    <!-- ⚙️ボタンとパネル -->
    <button id="settings-btn">⚙️</button>
    <div id="controls">
      <label><input type="checkbox" id="toggleUser"> ユーザー名表示</label>
      <label><input type="checkbox" id="toggleChat" checked> チャット欄</label><hr>
      透明度: <input type="range" id="opacity" min="0.2" max="1" step="0.1" value="1"><br>
      速度: <input type="range" id="speed" min="3" max="15" step="1" value="8"><br>
      サイズ: <input type="range" id="size" min="14" max="40" step="2" value="20"><br>
      <label><input type="checkbox" id="toggleShadow" checked> 影</label>
      <label><input type="checkbox" id="toggleStroke"> 縁取り</label>
    </div>
  </div>

  <!-- 右：公式チャット -->
  <iframe id="chat"></iframe>

  <script src="./tmi.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel") || "kato_junichi0817";

    // Twitch プレイヤー
    document.getElementById("stream").src =
      `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&muted=true`;

    // 公式チャット
    document.getElementById("chat").src =
      `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}&darkpopout`;

    // tmi.js クライアント
    const client = new tmi.Client({
      connection: { reconnect: true },
      channels: [ channel ]
    });
    client.connect();

    const settings = {
      showUser: false,
      opacity: 1,
      speed: 8,
      size: 20,
      shadow: true,
      stroke: false
    };

    const laneCount = 10;
    const lanes = Array(laneCount).fill(0);

    client.on("message", (chan, tags, message, self) => {
      if(self) return;
      addDanmaku(message, tags.emotes, tags['display-name']);
    });

    function addDanmaku(text, emotes, username) {
      const danmaku = document.getElementById("danmaku");
      const msg = document.createElement("div");
      msg.className = "danmaku-message";
      msg.style.opacity = settings.opacity;
      msg.style.fontSize = settings.size + "px";
      msg.style.animationDuration = settings.speed + "s";

      let effects = [];
      if (settings.shadow) effects.push("2px 2px 4px rgba(0,0,0,0.8)");
      if (settings.stroke) {
        msg.classList.add("stroke");
        msg.style.webkitTextStroke = "1px black";
        msg.style.paintOrder = "stroke fill";
      } else {
        msg.classList.remove("stroke");
        msg.style.webkitTextStroke = "0";
      }
      msg.style.textShadow = effects.join(",");

      if (settings.showUser) {
        const nameSpan = document.createElement("span");
        nameSpan.textContent = username + ": ";
        msg.appendChild(nameSpan);
      }

      if (emotes) {
        let fragments = [];
        let lastIndex = 0;
        const positions = [];
        for (let id in emotes) {
          emotes[id].forEach(pos => {
            const [start, end] = pos.split("-").map(Number);
            positions.push({ start, end, id });
          });
        }
        positions.sort((a,b) => a.start - b.start);

        positions.forEach(({ start, end, id }) => {
          if (lastIndex < start) {
            fragments.push(document.createTextNode(text.slice(lastIndex, start)));
          }
          const img = document.createElement("img");
          img.src = `https://static-cdn.jtvnw.net/emoticons/v2/${id}/default/dark/3.0`;
          img.style.height = settings.size * 1.2 + "px";
          img.style.verticalAlign = "middle";
          fragments.push(img);
          lastIndex = end + 1;
        });
        if (lastIndex < text.length) {
          fragments.push(document.createTextNode(text.slice(lastIndex)));
        }
        fragments.forEach(f => msg.appendChild(f));
      } else {
        msg.appendChild(document.createTextNode(text));
      }

      const now = Date.now() / 1000;
      let laneIndex = lanes.findIndex(end => end <= now);
      if (laneIndex === -1) {
        laneIndex = lanes.indexOf(Math.min(...lanes));
      }
      lanes[laneIndex] = now + settings.speed;

      const lineHeight = settings.size * 1.2;
      msg.style.top = `${laneIndex * lineHeight}px`;

      danmaku.appendChild(msg);
      setTimeout(() => msg.remove(), settings.speed * 1000);
    }

    document.getElementById("toggleUser").onchange = e => settings.showUser = e.target.checked;
    document.getElementById("opacity").oninput = e => settings.opacity = e.target.value;
    document.getElementById("speed").oninput = e => settings.speed = e.target.value;
    document.getElementById("size").oninput = e => settings.size = e.target.value;
    document.getElementById("toggleShadow").onchange = e => settings.shadow = e.target.checked;
    document.getElementById("toggleStroke").onchange = e => settings.stroke = e.target.checked;

    document.getElementById("toggleChat").onchange = e => {
      document.getElementById("chat").style.display = e.target.checked ? "block" : "none";
    };

    document.getElementById("settings-btn").onclick = () => {
      const panel = document.getElementById("controls");
      panel.style.display = (panel.style.display === "block") ? "none" : "block";
    };

    // スマホ: タップしたら数秒だけ表示
    let hideTimeout;
    document.getElementById("video-container").addEventListener("touchstart", () => {
      const btn = document.getElementById("settings-btn");
      btn.style.opacity = 1;
      btn.style.pointerEvents = "auto";
      clearTimeout(hideTimeout);
      hideTimeout = setTimeout(() => {
        btn.style.opacity = 0;
        btn.style.pointerEvents = "none";
      }, 3000);
    });
  </script>
</body>
</html>
