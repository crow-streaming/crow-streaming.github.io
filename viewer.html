<!DOCTYPE html>
<html lang="ja">
  <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>

<head>
  <meta charset="UTF-8">
  <title>配信ビューア</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #18181b;
      color: #fff;
      overflow: hidden;
    }
    /* 左エリア（動画+弾幕） */
    #video-container {
      position: relative;
      flex: 2;
      height: 100%;
      background: black;
    }
    #stream {
      width: 100%;
      height: 100%;
      border: none;
    }
    #danmaku {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .danmaku-message {
      position: absolute;
      white-space: nowrap;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      color: white;
      animation: moveLeft 8s linear forwards;
    }
    @keyframes moveLeft {
      from { left: 100%; }
      to { left: -100%; }
    }

    /* 右エリア（公式チャットiframe） */
    #chat {
      flex: 1;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <!-- 左：配信 + 弾幕 -->
  <div id="video-container">
    <iframe id="stream" allowfullscreen allow="autoplay; fullscreen"></iframe>
    <div id="danmaku"></div>
  </div>

  <!-- 右：公式チャット -->
  <iframe id="chat"></iframe>



  <script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get("channel") || "kato_junichi0817";

    // Twitch プレイヤー埋め込み（自動ミュート再生）
    document.getElementById("stream").src =
      `https://player.twitch.tv/?channel=${channel}&parent=${location.hostname}&muted=true`;

    // Twitch 公式チャット埋め込み（ダークモード）
    document.getElementById("chat").src =
      `https://www.twitch.tv/embed/${channel}/chat?parent=${location.hostname}&darkpopout`;

    // tmi.js クライアントでチャット取得
    // (ブラウザ用ビルドがロードされていれば `tmi` が定義されます)
    const client = new tmi.Client({
      connection: { reconnect: true },
      channels: [ channel ]
    });

    client.connect().catch(err => {
      console.error("tmi connect error:", err);
    });

    client.on("message", (chan, tags, message, self) => {
      if (self) return;
      addDanmaku(`${tags['display-name']}: ${message}`);
    });

    // 弾幕表示
    function addDanmaku(text) {
      const danmaku = document.getElementById("danmaku");
      const msg = document.createElement("div");
      msg.className = "danmaku-message";
      msg.innerText = text;
      // 少し上下に余裕を持たせる（重なり軽減）
      msg.style.top = `${5 + Math.random() * 80}%`;
      danmaku.appendChild(msg);
      // 消すタイミングはアニメーションの長さ(8s)と同じに
      setTimeout(() => msg.remove(), 8000);
    }
  </script>
</body>
</html>
