<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Twitch DANMAKU Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background: #0e0e10;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #9146FF;
      margin-bottom: 20px;
      text-align: center;
    }
    button {
      margin: 10px 0;
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background: #9146FF;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #772ce8;
    }
    input {
      padding: 10px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      outline: none;
      background: #1f1f23;
      color: white;
      width: 70%;
      max-width: 280px;
      margin-right: 8px;
    }
    section {
      background: #1f1f23;
      border-radius: 12px;
      padding: 16px;
      margin: 15px 0;
      width: 100%;
      max-width: 700px;
    }
    section h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 12px;
      color: #ddd;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    li {
      margin: 10px 0;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      background: #26262c;
      display: flex;
      align-items: center;
      transition: background 0.2s;
    }
    li:hover {
      background: #323239;
    }
    img {
      width: 120px;
      height: 67px;
      object-fit: cover;
    }
    .info {
      padding: 8px;
      flex: 1;
    }
    .info strong {
      display: block;
      font-size: 1rem;
      margin-bottom: 4px;
    }
    .info span {
      font-size: 0.85rem;
      color: #aaa;
    }
    @media (max-width: 600px) {
      input {
        width: 100%;
        margin-bottom: 10px;
      }
      button {
        width: 100%;
      }
      li {
        flex-direction: column;
        align-items: flex-start;
      }
      img {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <h1>Twitch DANMAKU Viewer</h1>
  <button id="loginBtn">ğŸ® Twitchã§ãƒ­ã‚°ã‚¤ãƒ³</button>

  <section>
    <h2>ğŸ” é…ä¿¡è€…æ¤œç´¢</h2>
    <div style="display:flex; flex-wrap:wrap; gap:8px;">
      <input type="text" id="searchInput" placeholder="é…ä¿¡è€…ã®IDã‚’å…¥åŠ›">
      <button id="searchBtn">æ¤œç´¢</button>
    </div>
    <ul id="searchResults"></ul>
  </section>

  <section>
    <h2>ğŸ‘¤ ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ï¼ˆé…ä¿¡ä¸­ã®ã¿ï¼‰</h2>
    <ul id="followList"><li>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</li></ul>
  </section>

  <section>
    <h2>ğŸ”¥ ãŠã™ã™ã‚é…ä¿¡ï¼ˆæ—¥æœ¬èªï¼‰</h2>
    <button id="refreshBtn">æ›´æ–°</button>
    <ul id="recommendList"></ul>
  </section>

  <script>
    const clientId = "g905kx93acaex9svg1jrwjdyp5j8sk"; 
    const redirectUri = location.origin + location.pathname; 
    const scopes = "user:read:follows";
    let accessToken = null;

    // ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹
    document.getElementById("loginBtn").onclick = () => {
      const url = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scopes}`;
      window.location = url;
    };

    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
    function getAccessToken() {
      const hash = window.location.hash;
      if (hash.includes("access_token")) {
        return new URLSearchParams(hash.substring(1)).get("access_token");
      }
      return null;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    async function getUser(token) {
      const res = await fetch("https://api.twitch.tv/helix/users", {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      return data.data[0];
    }

    // ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®é…ä¿¡è€…ï¼ˆé…ä¿¡ä¸­ã®ã¿ï¼‰
    async function loadFollows(token, userId) {
      const res = await fetch(`https://api.twitch.tv/helix/streams/followed?user_id=${userId}`, {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      renderList(data.data, document.getElementById("followList"));
    }

    // æ—¥æœ¬èªé…ä¿¡ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§5ä»¶
    async function loadRecommend(token) {
      const res = await fetch(`https://api.twitch.tv/helix/streams?first=100&language=ja`, {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      let streams = data.data;
      if (streams.length === 0) {
        document.getElementById("recommendList").innerHTML = "<li>ãŠã™ã™ã‚é…ä¿¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</li>";
        return;
      }
      const randomPick = [];
      for (let i = 0; i < 5 && streams.length > 0; i++) {
        const idx = Math.floor(Math.random() * streams.length);
        randomPick.push(streams[idx]);
        streams.splice(idx, 1);
      }
      renderList(randomPick, document.getElementById("recommendList"));
    }

    // æ¤œç´¢æ©Ÿèƒ½ï¼ˆé…ä¿¡ä¸­ã®ã¿ï¼‰
    async function searchChannels(token, query) {
      const res = await fetch(`https://api.twitch.tv/helix/search/channels?query=${encodeURIComponent(query)}&first=5`, {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      renderList(data.data.filter(ch => ch.is_live), document.getElementById("searchResults"));
    }

    // ãƒªã‚¹ãƒˆæç”»å…±é€šå‡¦ç†
    function renderList(streams, target) {
      target.innerHTML = "";
      if (streams.length === 0) {
        target.innerHTML = "<li>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</li>";
        return;
      }
      streams.forEach(stream => {
        const userName = stream.user_name || stream.display_name;
        const login = stream.user_login || stream.broadcaster_login;
        const viewers = stream.viewer_count ? `ğŸŸ¢ ${stream.viewer_count}äººè¦–è´ä¸­` : "";
        const thumb = stream.thumbnail_url
          ? stream.thumbnail_url.replace("{width}", "320").replace("{height}", "180")
          : "https://static-cdn.jtvnw.net/previews-ttv/live_user_" + login + "-320x180.jpg";

        const li = document.createElement("li");
        li.innerHTML = `
          <img src="${thumb}" alt="${userName}">
          <div class="info">
            <strong>${userName}</strong>
            <span>${viewers}</span>
          </div>`;
        li.onclick = () => {
          window.location.href = "viewer.html?channel=" + encodeURIComponent(login);
        };
        target.appendChild(li);
      });
    }

    // å®Ÿè¡Œ
    accessToken = getAccessToken();
    if (accessToken) {
      getUser(accessToken).then(user => {
        loadFollows(accessToken, user.id);
        loadRecommend(accessToken);
      });
    }

    // æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("searchBtn").onclick = () => {
      const query = document.getElementById("searchInput").value.trim();
      if (query) searchChannels(accessToken, query);
    };

    // æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("refreshBtn").onclick = () => {
      if (accessToken) {
        loadRecommend(accessToken);
      }
    };
  </script>
</body>
</html>
