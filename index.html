<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Twitch ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0e0e10, #1c1c1f);
      color: white;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #9146FF;
      text-shadow: 0 0 10px rgba(145,70,255,0.6);
      margin-bottom: 20px;
      text-align: center;
    }
    button {
      margin: 10px 0 20px 0;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      background: linear-gradient(90deg, #9146FF, #772ce8);
      color: white;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(145,70,255,0.5);
    }
    input {
      padding: 12px;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      outline: none;
      background: rgba(255,255,255,0.08);
      color: white;
      width: 70%;
      max-width: 280px;
      margin-right: 8px;
    }
    input:focus {
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 2px #9146FF;
    }
    section {
      background: rgba(30, 30, 35, 0.7);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 20px;
      margin: 15px 0;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    section h2 {
      margin-top: 0;
      font-size: 1.2rem;
      margin-bottom: 12px;
      color: #ddd;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    li {
      padding: 14px;
      margin: 8px 0;
      background: #1f1f23;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    li:hover {
      background: #29292e;
    }
    @media (max-width: 600px) {
      input {
        width: 100%;
        margin-bottom: 10px;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Twitch ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
  <button id="loginBtn">ğŸ® Twitchã§ãƒ­ã‚°ã‚¤ãƒ³</button>

  <section>
    <h2>ğŸ” é…ä¿¡è€…æ¤œç´¢</h2>
    <div style="display:flex; flex-wrap:wrap; gap:8px;">
      <input type="text" id="searchInput" placeholder="é…ä¿¡è€…åã‚’å…¥åŠ›">
      <button id="searchBtn">æ¤œç´¢</button>
    </div>
    <ul id="searchResults"></ul>
  </section>

  <section>
    <h2>ğŸ‘¤ ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ï¼ˆé…ä¿¡ä¸­ã®ã¿ï¼‰</h2>
    <ul id="followList"><li>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</li></ul>
  </section>

  <section>
    <h2>ğŸ”¥ ãŠã™ã™ã‚é…ä¿¡ï¼ˆæ—¥æœ¬èªãƒ©ãƒ³ãƒ€ãƒ 5ä»¶ï¼‰</h2>
    <ul id="recommendList"></ul>
  </section>

  <script>
    const clientId = "g905kx93acaex9svg1jrwjdyp5j8sk"; 
    const redirectUri = location.origin + location.pathname; 
    const scopes = "user:read:follows";
    let accessToken = null;

    // ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹
    document.getElementById("loginBtn").onclick = () => {
      const url = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scopes}`;
      window.location = url;
    };

    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
    function getAccessToken() {
      const hash = window.location.hash;
      if (hash.includes("access_token")) {
        return new URLSearchParams(hash.substring(1)).get("access_token");
      }
      return null;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    async function getUser(token) {
      const res = await fetch("https://api.twitch.tv/helix/users", {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      return data.data[0];
    }

    // ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®é…ä¿¡è€…ï¼ˆé…ä¿¡ä¸­ã®ã¿ï¼‰
    async function loadFollows(token, userId) {
      const res = await fetch(`https://api.twitch.tv/helix/streams/followed?user_id=${userId}`, {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      renderList(data.data, document.getElementById("followList"));
    }

    // æ—¥æœ¬èªé…ä¿¡ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§5ä»¶
    async function loadRecommend(token) {
      const res = await fetch(`https://api.twitch.tv/helix/streams?first=100&language=ja`, {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      let streams = data.data;
      if (streams.length === 0) {
        document.getElementById("recommendList").innerHTML = "<li>ãŠã™ã™ã‚é…ä¿¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</li>";
        return;
      }
      const randomPick = [];
      for (let i = 0; i < 5 && streams.length > 0; i++) {
        const idx = Math.floor(Math.random() * streams.length);
        randomPick.push(streams[idx]);
        streams.splice(idx, 1);
      }
      renderList(randomPick, document.getElementById("recommendList"));
    }

    // æ¤œç´¢æ©Ÿèƒ½ï¼ˆé…ä¿¡ä¸­ã®ã¿ï¼‰
    async function searchChannels(token, query) {
      const res = await fetch(`https://api.twitch.tv/helix/search/channels?query=${encodeURIComponent(query)}&first=5`, {
        headers: {
          "Authorization": "Bearer " + token,
          "Client-Id": clientId
        }
      });
      const data = await res.json();
      renderList(data.data.filter(ch => ch.is_live), document.getElementById("searchResults"));
    }

    // ãƒªã‚¹ãƒˆæç”»å…±é€šå‡¦ç†
    function renderList(streams, target) {
      target.innerHTML = "";
      if (streams.length === 0) {
        target.innerHTML = "<li>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</li>";
        return;
      }
      streams.forEach(stream => {
        const userName = stream.user_name || stream.display_name;
        const login = stream.user_login || stream.broadcaster_login;
        const viewers = stream.viewer_count ? `ğŸŸ¢ ${stream.viewer_count}äºº` : "";
        const li = document.createElement("li");
        li.innerHTML = `<span>${userName}</span><span>${viewers}</span>`;
        li.onclick = () => {
          window.location.href = "viewer.html?channel=" + encodeURIComponent(login);
        };
        target.appendChild(li);
      });
    }

    // å®Ÿè¡Œ
    accessToken = getAccessToken();
    if (accessToken) {
      getUser(accessToken).then(user => {
        loadFollows(accessToken, user.id);
        loadRecommend(accessToken);
      });
    }

    // æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("searchBtn").onclick = () => {
      const query = document.getElementById("searchInput").value.trim();
      if (query) searchChannels(accessToken, query);
    };
  </script>
</body>
</html>
